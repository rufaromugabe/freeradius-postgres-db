# FreeRADIUS with PostgreSQL Backend
# Docker Compose configuration for production-ready RADIUS server
#
# Quick start:
#   1. Copy .env.example to .env and customize
#   2. Run: docker-compose up -d
#   3. Test: docker-compose exec freeradius radtest bob test localhost 0 testing123

services:
  postgres:
    image: postgres:16-alpine
    container_name: freeradius-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: radius
      POSTGRES_USER: radius
      POSTGRES_PASSWORD: radiuspassword
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./sql/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - ./sql/seed.sql:/docker-entrypoint-initdb.d/02-seed.sql
    networks:
      - radius-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U radius"]
      interval: 10s
      timeout: 5s
      retries: 5

  freeradius:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: freeradius-server
    restart: unless-stopped
    ports:
      # RADIUS authentication port
      - "1812:1812/udp"
      # RADIUS accounting port
      - "1813:1813/udp"
    volumes:
      - ./raddb/clients.conf:/mnt/clients.conf:ro
      - ./raddb/users:/mnt/users:ro
      - ./raddb/mods-available/sql:/mnt/mods-available-sql:ro
      - ./raddb/mods-enabled/sql:/mnt/mods-enabled-sql:ro
      - ./raddb/sites-available/default:/mnt/sites-available-default:ro
      - ./raddb/sites-available/default:/mnt/sites-enabled-default:ro
      - radius_logs:/var/log/radius
    networks:
      - radius-net
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - TZ=UTC
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=radius
      - DB_USER=radius
      - DB_PASSWORD=radiuspassword
      - RADIUS_DEBUG=${RADIUS_DEBUG:-no}
    # Uncomment if you need to debug with gdb
    # privileged: true

networks:
  radius-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  postgres_data:
    driver: local
  pgadmin_data:
    driver: local
  radius_logs:
    driver: local